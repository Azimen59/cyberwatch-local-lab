version: "3.9"

services:
  # =========================
  # OpenCTI + dépendances
  # =========================
  redis:
    image: redis:7
    container_name: cw-redis
    restart: unless-stopped
    networks:
      - cw-net
    volumes:
      - cyberwatch-local_redis_data:/data

  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.14.0
    container_name: cw-elasticsearch
    environment:
      - discovery.type=single-node
      - ES_JAVA_OPTS=-Xms2G -Xmx2G
      - xpack.security.enabled=false
      - xpack.security.http.ssl.enabled=false
      - xpack.security.transport.ssl.enabled=false
      - thread_pool.search.queue_size=5000
    ulimits:
      memlock:
        soft: -1
        hard: -1
    volumes:
      - cyberwatch-local_es_data:/usr/share/elasticsearch/data
    restart: unless-stopped
    networks:
      - cw-net

  minio:
    image: minio/minio:latest
    container_name: cw-minio
    command: server /data --console-address ":9001"
    environment:
      - MINIO_ROOT_USER=opencti
      - MINIO_ROOT_PASSWORD=CHANGE_ME_MINIO_PASSWORD
    volumes:
      - cyberwatch-local_minio_data:/data
    ports:
      - "9000:9000"
      - "9001:9001"
    restart: unless-stopped
    networks:
      - cw-net

  rabbitmq:
    image: rabbitmq:3-management
    container_name: cw-rabbitmq
    environment:
      - RABBITMQ_DEFAULT_USER=opencti
      - RABBITMQ_DEFAULT_PASS=CHANGE_ME_RABBITMQ_PASSWORD
    volumes:
      - cyberwatch-local_rabbitmq_data:/var/lib/rabbitmq
    ports:
      - "5672:5672"
      - "15672:15672"
    restart: unless-stopped
    networks:
      - cw-net

  opencti:
    image: opencti/platform:6.5.0
    container_name: cw-opencti
    depends_on:
      - redis
      - elasticsearch
      - minio
      - rabbitmq
    environment:
      - NODE_ENV=production
      - APP__PORT=8080
      - APP__BASE_URL=http://opencti:8080
      - APP__ADMIN__EMAIL=changeme@example.com
      - APP__ADMIN__PASSWORD=CHANGE_ME_ADMIN_PASSWORD
      - APP__ADMIN__TOKEN=11111111-1111-1111-1111-111111111111
      - REDIS__HOSTNAME=redis
      - ELASTICSEARCH__URL=http://elasticsearch:9200
      - MINIO__ENDPOINT=minio
      - MINIO__PORT=9000
      - MINIO__USE_SSL=false
      - MINIO__ACCESS_KEY=opencti
      - MINIO__SECRET_KEY=CHANGE_ME_MINIO_PASSWORD
      - RABBITMQ__HOSTNAME=rabbitmq
      - RABBITMQ__PORT=5672
      - RABBITMQ__USERNAME=opencti
      - RABBITMQ__PASSWORD=CHANGE_ME_RABBITMQ_PASSWORD
    ports:
      - "8080:8080"
    volumes:
      - cyberwatch-local_opencti_data:/data
    restart: unless-stopped
    networks:
      - cw-net

  worker:
    image: opencti/platform:6.5.0
    container_name: cw-opencti-worker
    depends_on:
      - opencti
    environment:
      - NODE_ENV=production
      - OPENCTI_URL=http://opencti:8080
      - OPENCTI_TOKEN=11111111-1111-1111-1111-111111111111
      - REDIS__HOSTNAME=redis
    restart: unless-stopped
    networks:
      - cw-net

  # Connecteurs VirusTotal (optionnels : à désactiver si pas de clé)
  connector-virustotal:
    image: opencti/connector-virustotal:latest
    container_name: cw-connector-virustotal
    depends_on:
      - opencti
    environment:
      - OPENCTI_URL=http://opencti:8080
      - OPENCTI_TOKEN=11111111-1111-1111-1111-111111111111
      - CONNECTOR_ID=virustotal-import
      - CONNECTOR_TYPE=EXTERNAL_IMPORT
      - CONNECTOR_NAME=VirusTotal Import
      - CONNECTOR_SCOPE=virustotal
      - CONNECTOR_CONFIDENCE_LEVEL=75
      - CONNECTOR_LOG_LEVEL=info
      - VIRUSTOTAL_TOKEN=CHANGE_ME_VT_KEY
    restart: unless-stopped
    networks:
      - cw-net

  connector-virustotal-enrich:
    image: opencti/connector-virustotal:latest
    container_name: cw-connector-virustotal-enrich
    depends_on:
      - opencti
    environment:
      - OPENCTI_URL=http://opencti:8080
      - OPENCTI_TOKEN=11111111-1111-1111-1111-111111111111
      - CONNECTOR_ID=virustotal-enrich
      - CONNECTOR_TYPE=ENRICHMENT
      - CONNECTOR_NAME=VirusTotal Enrichment
      - CONNECTOR_SCOPE=StixFile,Url,Domain-Name,IPv4-Addr,IPv6-Addr
      - CONNECTOR_CONFIDENCE_LEVEL=75
      - CONNECTOR_LOG_LEVEL=info
      - VIRUSTOTAL_TOKEN=CHANGE_ME_VT_KEY
    restart: unless-stopped
    networks:
      - cw-net

  # =========================
  # Ollama (LLM local)
  # =========================
  ollama:
    image: ollama/ollama:0.5.0
    container_name: cw-ollama
    environment:
      - OLLAMA_KEEP_ALIVE=1800
    ports:
      - "11434:11434"
    volumes:
      - cyberwatch-local_ollama_data:/root/.ollama
    restart: unless-stopped
    networks:
      - cw-net

networks:
  cw-net:
    driver: bridge

volumes:
  cyberwatch-local_es_data:
  cyberwatch-local_minio_data:
  cyberwatch-local_opencti_data:
  cyberwatch-local_rabbitmq_data:
  cyberwatch-local_redis_data:
  cyberwatch-local_ollama_data:
